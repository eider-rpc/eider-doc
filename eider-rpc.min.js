(function(){'use strict';let a='object'==typeof self&&self.self===self&&self||'object'==typeof global&&global.global===global&&global||{},b=a.WebSocket;if(void 0===b)try{b=require('ws')}catch(a){}let c;if(void 0!==b&&(c=b.Server,void 0===c))try{c=require('ws').Server}catch(a){}let d;try{d=require('weak')}catch(b){d=a.weak}let e=function(a,b){return Promise.resolve(a).then((a)=>{let c,d=a._enter();try{c=b(d)}catch(b){throw a._exit(),b}return Promise.resolve(c).then((b)=>(a._exit(),b),(b)=>{throw a._exit(),b})})},f=Symbol.asyncIterator;void 0===f&&(f=Symbol('Symbol.asyncIterator'));let g=(a,b)=>e(a[f](),(a)=>{let c=()=>a.next().then((a)=>{if(!a.done)return Promise.resolve(b(a.value)).then(c)});return c()});const h='__*__';let i={};['AttributeError','CancelledError','DisconnectedError','IndexError','LookupError','RuntimeError'].forEach((a)=>{class b extends Error{}b.prototype.name=a,i[a]=b}),i.Exception=Error;const j=40,k=30,l=20,m=10,n={[j]:'error',[k]:'warning',[l]:'info',[m]:'debug'};let o=function(a){return'_'==a.substring(0,1)||'constructor'==a||'toJSON'==a},p=function(b,c){let d=b[c];if(void 0===d)throw new i.AttributeError('\''+b.constructor.name+'\' object has no attribute \''+c+'\'');if(d===Object.prototype[c])throw new i.AttributeError('Cannot access forbidden attribute \''+c+'\' of \''+b.constructor.name+'\' object');return d.bind(b)};class q{constructor(a,b,c,d=!0){this.name=a,this.encode=b,this.decode=c,this.inband=d,q.registry[a]=this}static byname(a){if(null===a)return null;let b=q.registry[a];if(void 0===b)throw new i.LookupError('Unknown format: '+a);return b}}q.registry={},new q('json',(a,b)=>{return JSON.stringify(b,function(b,c){switch(typeof c){case'boolean':case'number':case'string':return c;}return null===c||Array.isArray(c)?c:'function'==typeof c.toJSON?c.toJSON():Object.getPrototypeOf(c).constructor===Object?c:a.lsessions[-1].marshal(c,'function'==typeof c?'call':null)})},JSON.parse);let r;try{r=require('msgpack-lite')}catch(b){r=a.msgpack}if(void 0!==r){let a=r.decode([212,0,0]).constructor,b=r.createCodec({binarraybuffer:!0}),c={codec:b};b.addExtUnpacker(0,(a)=>new s(r.decode(a,c))),new q('msgpack',(b,d)=>{let e=function(c){switch(typeof c){case'boolean':case'number':case'string':return c;}return null===c?c:Array.isArray(c)?c.map(e):'function'==typeof c.toJSON?new a(r.encode(c.toJSON()),0):c instanceof ArrayBuffer||'[object ArrayBuffer]'==={}.toString.call(c)?c:ArrayBuffer.isView(c)?c.buffer:Object.getPrototypeOf(c).constructor===Object?Object.keys(c).reduce((a,b)=>(a[b]=e(c[b]),a),{}):b.lsessions[-1].marshal(c,'function'==typeof c?'call':null)};return r.encode(e(d),c)},(a)=>r.decode(a,c),!1)}class s{constructor(a){this.ref=a}toJSON(){return this.ref}}class t{constructor(a,b=null){this.conn=a,this.lcodec=q.byname(b)}unmarshalAll(a,b,c=null){return a.inband?this.unmarshalAllInBand(b,c):this.unmarshalAllOutOfBand(b,c)}unmarshalAllInBand(a,b=null){switch(typeof a){case'boolean':case'number':case'string':return a;}return null===a?a:Array.isArray(a)?a.map((a)=>this.unmarshalAllInBand(a,b)):h in a?this.unmarshal(a,b):Object.keys(a).reduce((c,d)=>(c[d]=this.unmarshalAllInBand(a[d],b),c),{})}unmarshalAllOutOfBand(a,b=null){switch(typeof a){case'boolean':case'number':case'string':return a;}return null===a?a:Array.isArray(a)?a.map((a)=>this.unmarshalAllOutOfBand(a,b)):a instanceof s?this.unmarshal(a.ref,b):a instanceof ArrayBuffer||'[object ArrayBuffer]'==={}.toString.call(a)?a:Object.keys(a).reduce((c,d)=>(c[d]=this.unmarshalAllOutOfBand(a[d],b),c),{})}unmarshal(a,b){let c=this.unmarshalObj(a,b),d=a.method;if(!d)return c;if(o(d))throw new i.AttributeError('Cannot access private attribute \''+d+'\' of \''+c.constructor.name+'\' object');return p(c,d)}_enter(){return this.root()}_exit(){this.close()}}class u extends t{constructor(a,b,c=null,d=null){if(b in a.lsessions)throw new i.RuntimeError('Session ID in use: '+b);super(a,d),this.lsid=b,this.nextloid=0,this.objects={},a.lsessions[b]=this;try{this.objects[null]=(c||a.rootFactory)(this)}catch(c){throw delete a.lsessions[b],c}}root(){return this.objects[null]}add(a){let b=this.nextloid++;return this.objects[b]=a,b}unmarshalObj(a,b){let c=a[h];if('lsid'in a){let d=new D(this.conn,a.lsid,null,b);return d.lcodec=this.lcodec,d.unmarshalId(c)}let d=this.conn.unmarshalLsession(a.rsid);return d.unmarshalId(c)}unmarshalId(a){if(!this.objects.hasOwnProperty(a))throw new i.LookupError('Unknown object: '+a);return this.objects[a]}close(){this.root().release()}destroy(){for(let a in this.objects)this.objects[a]._close();delete this.conn.lsessions[this.lsid]}free(a){let b=this.unmarshalId(a);b.release()}}class v extends u{marshal(a,b=null){let c=this.nextloid++;this.objects[c]=a;let d={[h]:c,lsid:this.lsid};return null!==b&&(d.method=b),d}unmarshalId(a){let b=super.unmarshalId(a);return'function'==typeof b?{call:{bind:()=>b}}:b}destroy(){delete this.conn.lsessions[this.lsid]}free(a){if(null===a)return super.free(null);if(!this.objects.hasOwnProperty(a))throw new i.LookupError('Unknown object: '+a);delete this.objects[a]}}class w{constructor(a,b){return this._lsession=a,this._loid=b,this._lref={lsid:a.lsid,[h]:b},new Proxy(this,{get:(a,b)=>{let c=a[b];return'function'==typeof c?new Proxy(c,{get:(a,d)=>{let e=a[d];return'bind'===d?function(a,...d){let f=e.call(this,a,...d);return f.toJSON=()=>(++a._nref,{lsid:a._lsession.lsid,[h]:a._loid,method:b}),f.help=c.help,f}:e}}):c}})}toJSON(){return++this._nref,this._lref}addref(){++this._nref}release(){0>=--this._nref&&this._release()}help(a=null){return null===a?this.constructor.help||null:a.help||null}dir(){let a=this,b=[];for(;a!==Object.prototype;)b=b.concat(Object.getOwnPropertyNames(a)),a=Object.getPrototypeOf(a);return b.sort().filter((a,b,c)=>a!==c[b+1]&&!o(a)&&'function'==typeof this[a])}taxa(){let a=Object.getPrototypeOf(this),b=[];for(;null!==a&&a.constructor!==x&&a.constructor!==z;)b.push(a.constructor.name),a=Object.getPrototypeOf(a);return b}signature(a){let b=[];for(let c=0;c<a.length;++c)b.push(['abcdefghijklmnopqrstuvwxyz'.charAt(c),null]);return b.push(['*args',null]),{params:b,defaults:{},return:null}}_release(){delete this._lsession.objects[this._loid],this._close()}_close(){}_enter(){return++this._nref,this}_exit(){this.release()}}w.prototype.addref.help='Increment the object\'s reference count.',w.prototype.release.help='Decrement the object\'s reference count.  When the reference count reaches zero,\nit will be removed from memory.',w.prototype.help.help='Get documentation for the object or one of its methods.',w.prototype.dir.help='Get a list of names of the object\'s methods.',w.prototype.taxa.help='Get a list of names of the object\'s base classes.',w.prototype.signature.help='Get method type signature.';class x extends w{constructor(a){super(a,null),this._nref=1}_close(){this._lsession.destroy()}static setNewables(a,b){b.forEach((b)=>{let c=b._new;void 0===c&&(c=(...a)=>new b(...a),c.help=b.help),(a.prototype['new_'+b.name]=function(...a){return c(this._lsession,...a)}).help=c.help})}}class y extends x{open(a,b=null){this._lsession.conn.createLocalSession(a,null,b)}free(a,b){let c=this._lsession.conn.unmarshalLsession(a);c.free(b)}}y.prototype.open.help='Open a new session.',y.prototype.free.help='Release the specified object, which may be a native object.';class z extends w{constructor(a){let b=a.nextloid++;super(a,b),a.objects[b]=this,this._nref=0}}let A=(a)=>new Promise((b,c)=>{a.closed?b():a.rsession.closed()||a.rsession.conn.closed()?(a.closed=!0,b()):(a.closed=!0,a.rsession.call(null,'free',[a.rref.rsid,a.rref[h]]).then(b,(a)=>{a instanceof i.LookupError||a instanceof i.DisconnectedError?b():c(a)}))});class B{constructor(a,b){let c={rsession:a,rref:{rsid:a.rsid,[h]:b},closed:!1};return this._rdata=c,void 0!==d&&d(this,A.bind(void 0,c)),new Proxy(this,{get:(b,c)=>{let d=b[c];if(void 0!==d)return d;if('string'==typeof c&&'inspect'!==c&&'then'!==c&&'toJSON'!==c){let b=function(...b){return a.call(this,c,b)};return b.bind=function(a,...b){let d=Function.prototype.bind.call(this,a,...b);return d.toJSON=()=>({rsid:a._rdata.rref.rsid,[h]:a._rdata.rref[h],method:c}),d.close=()=>a._close(),d._enter=()=>d,d._exit=()=>d.close(),d.help=()=>a.help(d),d.signature=()=>a.signature(d),d},b}}})}toJSON(){return this._rdata.rref}_close(){return A(this._rdata)}_enter(){return this}_exit(){this._close()}[f](){return new C(this)}}class C{constructor(a){this.robj=a,this.iter=-1}[f](){return this}next(){let a=this.iter;if(null===a)return Promise.resolve({value:void 0,done:!0});let b=(a)=>this.robj.get(a).then((b)=>(this.iter=a+1,{value:b,done:!1}),(a)=>{if(a instanceof i.IndexError)return this.iter=null,{value:void 0,done:!0};throw this.iter=null,a}),c=(a)=>a.next().then((b)=>b.done?(this.iter=null,a._close(),{value:void 0,done:!0}):{value:b.value,done:b.done},(b)=>{throw this.iter=null,a._close(),b});return-1===a?this.robj.iter().then((a)=>(this.iter=a,c(a)),(a)=>{if(a instanceof i.AttributeError)return this.iter=0,b(0);throw this.iter=null,a}):'number'==typeof a?b(a):c(a)}close(){let a=this.iter;this.iter=null,a instanceof B&&a._close()}_enter(){return this}_exit(){this.close()}}class D extends t{constructor(a,b,c=null,d=null){super(a,c),this.rsid=b,this.dstid=d}call(a,b,c=[]){let d=this.conn.nextrcid++;this.conn.sendcall(this.lcodec,this.dstid,d,a,b,c);let e=new Promise((a,b)=>{this.conn.rcalls[d]={rsession:this,resolve:a,reject:b}});return e.cancel=()=>{let a=this.conn.rcalls[d];if(void 0!==a){delete this.conn.rcalls[d];let b={cancel:d};null!==this.dstid&&(b.dst=this.dstid),this.conn.send(b),a.reject(new i.CancelledError)}},e}unmarshalObj(a){let b=a[h];if('rsid'in a){let c=this.conn.unmarshalLsession(a.rsid);return c.unmarshalId(b)}let c,d=a.lsid;d===this.rsid?c=this:(c=this.createExternalSession(this.conn,d,null,this.dstid),c.lcodec=this.lcodec);let e=c.unmarshalId(b);return'bridge'in a?c.unmarshalBridge(e,a.bridge):e}unmarshalBridge(a,b){return new G(a,b)}unmarshalId(a){return new B(this,a)}closed(){return!1}createExternalSession(...a){return new D(...a)}}class E extends D{constructor(a,b,c=null,d=null,e=null){super(a,b,c,e),Promise.resolve(this._open(d)).catch(()=>{}),this._root=this.unmarshalId(null)}root(){return this._root}closed(){return this._root._rdata._closed}}class F extends E{constructor(a,b=null,c=null){super(a,a.nextrsid++,b,c)}_open(a){return this.call(null,'open',[this.rsid,a])}close(){return this._root._close()}}class G extends E{constructor(a,b){super(a._rdata.rsession.conn,b.rsid,b.lformat,null,b.dst),this.bridge=a,this._root._closed=!0}_open(){}close(){return this.bridge._close()}closed(){return this.bridge._rdata._closed}}class H extends z{constructor(a,b,c='json',d='json'){super(a),this._rsession=new F(b,null,d),this._lref.bridge={dst:b.id,rsid:this._rsession.rsid,lformat:c}}_close(){this._rsession.close()}}H.help='Bridge between clients.  Allows one client to call methods exposed by another client.';class I{constructor(){this.objects={},this.nextid=0}add(a){let b=this.nextid++;return this.objects[b]=a,b}get(a){return this.objects[a]}remove(a){delete this.objects[a]}}let J=new I;class K{constructor(a,c={}){if(c.rootFactory)this.rootFactory=c.rootFactory;else{let a=c.root||x;this.rootFactory=(b)=>new a(b)}this.onopen=c.onopen||(()=>{}),this.onclose=c.onclose||(()=>{}),this.logfn=c.log||((a,...b)=>{console.log(n[a]||'Unknown',...b)}),this.logLevel=void 0===c.logLevel?k:c.logLevel,this.lencode=q.registry[c.lformat||'json'].encode,this.rcodec=q.registry[c.rformat||'json'],this.rcodecBin=q.registry[c.rformatBin||'msgpack'],this.lsessions={},this.lcalls={},this.rcalls={},this.bcalls={},this.nextlsid=-2,this.nextrsid=0,this.nextrcid=0,this.header=null,this.headerRcodec=null,new u(this,null,(a)=>new y(a)),new v(this,-1,(a)=>new x(a)),this.registry=c.registry?c.registry:J,this.id=this.registry.add(this);let d='string'==typeof a?new b(a):a;3===d.readyState?(this.ws=null,this.registry.remove(this.id),setTimeout(()=>this.onclose(this),0)):(this.ws=d,1===d.readyState?setTimeout(()=>this.onopen(this),0):d.onopen=()=>{this.onopen(this)},d.onclose=()=>{this.ws=null,this.lclose(),this.rclose(),this.onclose(this)},d.onmessage=(a)=>{if(this.log(m,'recv',a.data),null===this.header){let b,c='string'==typeof a.data?this.rcodec:this.rcodecBin;try{b=c.decode(a.data)}catch(a){return this.log(j,'Invalid data received on Eider WebSocket connection:',a),void this.close()}'format'in b&&null!==b.format?(this.header=b,this.headerRcodec=c):this.dispatch(c,b)}else this.dispatch(this.headerRcodec,this.header,a.data),this.header=null})}closed(){return null===this.ws||1!==this.ws.readyState}createLocalSession(a=null,b=null,c=null){return null===a&&(a=this.nextlsid--),new u(this,a,b,c)}createSession(a=null,b=null){return new F(this,a,b)}dispatch(a,b,c=null){let d=b.dst;void 0===d&&(d=null);let e=b.method;if(e){let f=b.id;if(void 0===f&&(f=null),null===d){let d=b.src;void 0===d&&(d=null);try{if(o(e))throw new i.AttributeError('Cannot call private method \''+e+'\'');let g;null===c?g=b:(a=q.byname(b.format),g=a.decode(c));let[h,j]=this.applyBegin(a,d,e,g),k=h.lcodec;try{let b=this.applyFinish(a,d,e,h,j,g);null!==f&&b&&'function'==typeof b.then&&'function'==typeof b.cancel&&(this.lcalls[f]=b),Promise.resolve(b).then((a)=>{null!==f&&(f in this.lcalls&&delete this.lcalls[f],this.respond(d,f,a,k))}).catch((a)=>{f in this.lcalls&&delete this.lcalls[f],this.onError(d,f,a,k)})}catch(a){this.onError(d,f,a,k)}}catch(a){this.onError(d,f,a)}}else this.bridgeCall(d,f,b,c)}else{let e=b.cancel;if(void 0===e||null===e){let e=b.id;if(null===d){let d=this.rcalls[e];if(void 0!==d){delete this.rcalls[e];try{let e;null===c?e=b:(a=q.byname(b.format),e=a.decode(c)),d.resolve(this.getresult(a,d.rsession,e))}catch(a){d.reject(a)}}}else this.bridgeResponse(d,e,b,c)}else if(null===d){let a=this.lcalls[e];void 0!==a&&(delete this.lcalls[e],a.cancel())}else this.bridgeCall(d,null,b,c)}}bridgeCall(a,b,c,d){let e=this.registry.get(a);void 0===e?this.onError(null,b,new i.DisconnectedError('Unknown connection: '+a)):(delete c.dst,c.src=this.id,e.send(c,d),null!==b&&((e.bcalls[this.id]||(e.bcalls[this.id]={}))[b]=1))}bridgeResponse(a,b,c,d){let e=this.registry.get(a);void 0!==e&&(this.bcalls[a]&&this.bcalls[a][b]&&delete this.bcalls[a][b],delete c.dst,e.send(c,d))}unmarshalLsession(a){if(!this.lsessions.hasOwnProperty(a))throw new i.LookupError('Unknown session: '+a);return this.lsessions[a]}applyBegin(a,b,c,d){let e,f,g=d.this;if(void 0===g||null===g)e=null,f=null;else if(Array.isArray(g))throw new TypeError('Malformed this object');else g instanceof s&&(g=g.ref),e=g[h],void 0===e&&(e=null),f=g.rsid,void 0===f&&(f=null);return[this.unmarshalLsession(f),e]}applyFinish(a,b,c,d,e,g){let h=d.unmarshalId(e),i=p(h,c),f='params'in g?d.unmarshalAll(a,g.params,b):[];return i(...f)}getresult(b,c,d){if('result'in d)return c.unmarshalAll(b,d.result);let e=d.error;if(!e)throw new Error('Unspecified error');let f=e.message;f=void 0===f||''===f?'Unspecified error':''+f;let g=''+e.name,h=i[g]||a[g];'function'==typeof h&&(h===Error||h.prototype instanceof Error)||(h=Error,g&&(f=g+': '+f));let j=e.stack,k=new h(f);throw'string'==typeof j&&('string'==typeof k.stack?k.stack=j.trim()+'\n\nThe above exception was the direct cause of the following exception:\n\n'+k.stack:k.stack=j),k}onError(a,b,c,d=null){null===b?this.log(j,c):((void 0===c.name||void 0===c.message)&&(c=new Error(c)),this.error(a,b,c,d))}close(){null!==this.ws&&(this.ws.close(),this.ws=null,this.registry.remove(this.id))}lclose(){for(let a in this.lsessions)this.lsessions[a].objects[null]._release()}rclose(){for(let a in this.registry.remove(this.id),this.lcalls)this.lcalls[a].cancel();for(let a in this.rcalls)this.rcalls[a].reject(new i.DisconnectedError('Connection lost'));for(let a in this.bcalls){let b=this.registry.get(a);if(void 0!==b)for(let c in this.bcalls[a])b.error(null,c,new i.DisconnectedError('Bridged connection lost'))}for(let a in this.registry.objects){let b=this.registry.objects[a],c=b.bcalls[this.id];if(void 0!==c&&(delete b.bcalls[this.id],!b.closed()))for(let a in c)b.send({cancel:a})}}sendcall(a,b,c,d,e,f=[]){if(this.closed())throw new i.DisconnectedError('Connection closed');let g={id:c,method:e};null!==b&&(g.dst=b);let h;null===a?(h=null,null!==d&&(g.this=d),f.length&&(g.params=f)):(h={},null!==d&&(h.this=d),f.length&&(h.params=f),h=a.encode(this,h),g.format=a.name),this.send(g,h)}respond(a,b,c,d){void 0===c&&(c=null);let e={id:b};null!==a&&(e.dst=a);let f;if(null===d)f=null,e.result=c;else{try{f=d.encode(this,{result:c})}catch(c){return void this.error(a,b,c,d)}e.format=d.name}this.send(e,f)}error(a,b,c,d=null){let e={id:b};null!==a&&(e.dst=a);let f={name:c.name,message:c.message};'string'==typeof c.stack&&(f.stack=c.stack);let g;if(null===d)g=null,e.error=f;else try{g=d.encode(this,{error:f}),e.format=d.name}catch(a){g=null,e.error=f}this.send(e,g)}send(a,b=null){this.closed()||(this.sendData(this.lencode(this,a)),null!==b&&this.sendData(b))}sendData(a){this.log(m,'send',a),this.ws.send(a)}log(a,...b){a>=this.logLevel&&this.logfn(a,...b)}_enter(){return this}_exit(){this.close()}}let L=function(a,b={}){return new Promise((c,d)=>{let e=new K(a,b),f=b.onclose||(()=>{});e.onopen=(a)=>{a.onclose=f,c(a)},e.onclose=(a)=>{d(new Error('Could not connect')),f(a)}})},M=function(a,b={}){let d=new c({port:a});return d.on('connection',(a)=>L(a,b)),d},N={asyncIterator:f,Bridge:H,Codec:q,connect:L,Connection:K,Errors:i,forEachAsync:g,LocalObject:z,LocalRoot:x,LOG_ERROR:j,LOG_WARNING:k,LOG_INFO:l,LOG_DEBUG:m,Reference:s,Registry:I,serve:M,using:e,VERSION:'0.11.0'};'undefined'!=typeof module&&!module.nodeType&&module.exports?module.exports=N:a.Eider=N})();