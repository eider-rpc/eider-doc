(function(){'use strict';let c='object'==typeof self&&self.self===self&&self||'object'==typeof global&&global.global===global&&global||{},e=c.WebSocket;if(void 0===e)try{e=require('ws')}catch(U){}let g;if(void 0!==e&&(g=e.Server,void 0==g))try{g=require('ws').Server}catch(U){}let h;try{h=require('weak')}catch(U){h=c.weak}let j=function(U,V){return Promise.resolve(U).then(W=>{let X=W._enter(),Y;try{Y=V(X)}catch(Z){throw W._exit(),Z}return Promise.resolve(Y).then(Z=>{return W._exit(),Z},Z=>{throw W._exit(),Z})})},l=Symbol.asyncIterator;void 0===l&&(l=Symbol('Symbol.asyncIterator'));const p='__*__';let q={};['AttributeError','CancelledError','DisconnectedError','IndexError','LookupError','RuntimeError'].forEach(U=>{class V extends Error{}V.prototype.name=U,q[U]=V}),q.Exception=Error;let r=function(U){return'_'==U.substring(0,1)||'constructor'==U||'toJSON'==U},s=function(U,V){let W=U[V];if(void 0===W)throw new q.AttributeError('\''+U.constructor.name+'\' object has no attribute \''+V+'\'');if(W===Object.prototype[V])throw new q.AttributeError('Cannot access forbidden attribute \''+V+'\' of \''+U.constructor.name+'\' object');return W.bind(U)};class t{constructor(U,V,W,X=!0){this.name=U,this.encode=V,this.decode=W,this.inband=X,t.registry[U]=this}static byname(U){if(null===U)return null;let V=t.registry[U];if(void 0===V)throw new q.LookupError('Unknown format: '+U);return V}}t.registry={},new t('json',(U,V)=>{return JSON.stringify(V,function(X,Y){switch(typeof Y){case'boolean':case'number':case'string':return Y;}return null===Y||Array.isArray(Y)?Y:'function'==typeof Y.toJSON?Y.toJSON():Object.getPrototypeOf(Y).constructor===Object?Y:U.lsessions[-1].marshal(Y,'function'==typeof Y?'call':null)})},JSON.parse);let u;try{u=require('msgpack-lite')}catch(U){u=c.msgpack}if(void 0!==u){let U=u.decode([212,0,0]).constructor,V=u.createCodec({binarraybuffer:!0}),W={codec:V};V.addExtUnpacker(0,X=>new v(u.decode(X,W))),new t('msgpack',(X,Y)=>{let Z=function($){switch(typeof $){case'boolean':case'number':case'string':return $;}return null===$?$:Array.isArray($)?$.map(Z):'function'==typeof $.toJSON?new U(u.encode($.toJSON()),0):$ instanceof ArrayBuffer||'[object ArrayBuffer]'==={}.toString.call($)?$:ArrayBuffer.isView($)?$.buffer:Object.getPrototypeOf($).constructor===Object?Object.keys($).reduce((_,aa)=>{return _[aa]=Z($[aa]),_},{}):X.lsessions[-1].marshal($,'function'==typeof $?'call':null)};return u.encode(Z(Y),W)},X=>u.decode(X,W),!1)}class v{constructor(U){this.ref=U}toJSON(){return this.ref}}class w{constructor(U,V=null){this.conn=U,this.lcodec=t.byname(V)}unmarshalAll(U,V,W=null){return U.inband?this.unmarshalAllInBand(V,W):this.unmarshalAllOutOfBand(V,W)}unmarshalAllInBand(U,V=null){switch(typeof U){case'boolean':case'number':case'string':return U;}return null===U?U:Array.isArray(U)?U.map(W=>this.unmarshalAllInBand(W,V)):p in U?this.unmarshal(U,V):Object.keys(U).reduce((W,X)=>{return W[X]=this.unmarshalAllInBand(U[X],V),W},{})}unmarshalAllOutOfBand(U,V=null){switch(typeof U){case'boolean':case'number':case'string':return U;}return null===U?U:Array.isArray(U)?U.map(W=>this.unmarshalAllOutOfBand(W,V)):U instanceof v?this.unmarshal(U.ref,V):U instanceof ArrayBuffer||'[object ArrayBuffer]'==={}.toString.call(U)?U:Object.keys(U).reduce((W,X)=>{return W[X]=this.unmarshalAllOutOfBand(U[X],V),W},{})}unmarshal(U,V){let W=this.unmarshalObj(U,V),X=U.method;if(!X)return W;if(r(X))throw new q.AttributeError('Cannot access private attribute \''+X+'\' of \''+W.constructor.name+'\' object');return s(W,X)}_enter(){return this.root()}_exit(){this.close()}}class y extends w{constructor(U,V,W=null,X=null){if(V in U.lsessions)throw new q.RuntimeError('Session ID in use: '+V);super(U,X),this.lsid=V,this.nextloid=0,this.objects={},U.lsessions[V]=this;try{this.objects[null]=(W||U.rootFactory)(this)}catch(Y){throw delete U.lsessions[V],Y}}root(){return this.objects[null]}add(U){let V=this.nextloid++;return this.objects[V]=U,V}unmarshalObj(U,V){let W=U[p];if('lsid'in U){let Y=new J(this.conn,U.lsid,null,V);return Y.lcodec=this.lcodec,Y.unmarshalId(W)}let X=this.conn.unmarshalLsession(U.rsid);return X.unmarshalId(W)}unmarshalId(U){if(!this.objects.hasOwnProperty(U))throw new q.LookupError('Unknown object: '+U);return this.objects[U]}close(){this.root().release()}destroy(){for(let U in this.objects)this.objects[U]._close();delete this.conn.lsessions[this.lsid]}free(U){let V=this.unmarshalId(U);V.release()}}class z extends y{marshal(U,V){let W=this.nextloid++;return this.objects[W]=U,{[p]:W,lsid:this.lsid,method:V}}unmarshalId(U){let V=super.unmarshalId(U);return'function'==typeof V?{call:{bind:()=>V}}:V}destroy(){delete this.conn.lsessions[this.lsid]}free(U){if(null===U)return super.free(null);if(!this.objects.hasOwnProperty(U))throw new q.LookupError('Unknown object: '+U);delete this.objects[U]}}class A{constructor(U,V){return this._lsession=U,this._loid=V,this._lref={lsid:U.lsid,[p]:V},new Proxy(this,{get:(W,X)=>{let Y=W[X];return'function'==typeof Y?new Proxy(Y,{get:(Z,$)=>{let _=Z[$];return'bind'===$?function(aa,...ba){let ca=_.call(this,aa,...ba);return ca.toJSON=()=>{return++aa._nref,{lsid:aa._lsession.lsid,[p]:aa._loid,method:X}},ca.help=Y.help,ca}:_}}):Y}})}toJSON(){return++this._nref,this._lref}addref(){++this._nref}release(){0>=--this._nref&&this._release()}help(U=null){return null===U?this.constructor.help||null:U.help||null}dir(){let U=this,V=[];for(;U!==Object.prototype;)V=V.concat(Object.getOwnPropertyNames(U)),U=Object.getPrototypeOf(U);return V.sort().filter((W,X,Y)=>W!==Y[X+1]&&!r(W)&&'function'==typeof this[W])}taxa(){let U=Object.getPrototypeOf(this),V=[];for(;null!==U&&U.constructor!==B&&U.constructor!==F;)V.push(U.constructor.name),U=Object.getPrototypeOf(U);return V}signature(U){let V=[];for(let X=0;X<U.length;++X)V.push(['abcdefghijklmnopqrstuvwxyz'.charAt(X),null]);return V.push(['*args',null]),{params:V,defaults:{},'return':null}}_release(){delete this._lsession.objects[this._loid],this._close()}_close(){}_enter(){return++this._nref,this}_exit(){this.release()}}A.prototype.addref.help='Increment the object\'s reference count.',A.prototype.release.help='Decrement the object\'s reference count.  When the reference count reaches zero,\nit will be removed from memory.',A.prototype.help.help='Get documentation for the object or one of its methods.',A.prototype.dir.help='Get a list of names of the object\'s methods.',A.prototype.taxa.help='Get a list of names of the object\'s base classes.',A.prototype.signature.help='Get method type signature.';class B extends A{constructor(U){super(U,null),this._nref=1}_close(){this._lsession.destroy()}static setNewables(U,V){V.forEach(W=>{let X=W._new;void 0===X&&(X=(...Y)=>new W(...Y),X.help=W.help),(U.prototype['new_'+W.name]=function(...Y){return X(this._lsession,...Y)}).help=X.help})}}class D extends B{open(U,V=null){this._lsession.conn.createLocalSession(U,null,V)}free(U,V){let W=this._lsession.conn.unmarshalLsession(U);W.free(V)}}D.prototype.open.help='Open a new session.',D.prototype.free.help='Release the specified object, which may be a native object.';class F extends A{constructor(U){let V=U.nextloid++;super(U,V),U.objects[V]=this,this._nref=0}}let G=U=>{return new Promise((V,W)=>{if(U.closed)V();else{U.closed=!0;let X;try{X=U.rsession.call(null,'free',[U.rref.rsid,U.rref[p]])}catch(Y){Y instanceof q.DisconnectedError?V():W(Y)}void 0!==X&&X.then(V,Y=>{Y instanceof q.DisconnectedError||Y instanceof q.LookupError?V():W(Y)})}})};class H{constructor(U,V){let W={rsession:U,rref:{rsid:U.rsid,[p]:V},closed:!1};return this._rdata=W,void 0!==h&&h(this,G.bind(void 0,W)),new Proxy(this,{get:(X,Y)=>{let $=X[Y];if(void 0!==$)return $;if('string'==typeof Y&&'inspect'!==Y&&'then'!==Y&&'toJSON'!==Y){let _=function(...aa){return U.call(this,Y,aa)};return _.bind=function(aa,...ba){let ca=Function.prototype.bind.call(this,aa,...ba);return ca.toJSON=()=>({rsid:aa._rdata.rref.rsid,[p]:aa._rdata.rref[p],method:Y}),ca.close=()=>aa._close(),ca._enter=()=>ca,ca._exit=()=>ca.close(),ca.help=()=>aa.help(ca),ca.signature=()=>aa.signature(ca),ca},_}}})}toJSON(){return this._rdata.rref}_close(){return G(this._rdata)}_enter(){return this}_exit(){this._close()}[l](){return new I(this)}}class I{constructor(U){this.robj=U,this.iter=-1}[l](){return this}next(){let U=this.iter;if(null===U)return Promise.resolve({value:void 0,done:!0});let V=X=>this.robj.get(X).then(Y=>{return this.iter=X+1,{value:Y,done:!1}},Y=>{if(Y instanceof q.IndexError)return this.iter=null,{value:void 0,done:!0};throw this.iter=null,Y}),W=X=>X.next().then(Y=>{return Y.done?(this.iter=null,X._close(),{value:void 0,done:!0}):{value:Y.value,done:Y.done}},Y=>{throw this.iter=null,X._close(),Y});return-1===U?this.robj.iter().then(X=>{return this.iter=X,W(X)},X=>{if(X instanceof q.AttributeError)return this.iter=0,V(0);throw this.iter=null,X}):'number'==typeof U?V(U):W(U)}close(){let U=this.iter;this.iter=null,U instanceof H&&U._close()}_enter(){return this}_exit(){this.close()}}class J extends w{constructor(U,V,W=null,X=null){super(U,W),this.rsid=V,this.dstid=X}call(U,V,W=[]){let X=this.conn.nextrcid++;this.conn.sendcall(this.lcodec,this.dstid,X,U,V,W);let Y=new Promise((Z,$)=>{this.conn.rcalls[X]={rsession:this,resolve:Z,reject:$}});return Y.cancel=()=>{let Z=this.conn.rcalls[X];void 0!==Z&&(delete this.conn.rcalls[X],this.conn.send({dst:this.dstid,cancel:X}),Z.reject(new q.CancelledError))},Y}unmarshalObj(U){let V=U[p];if('rsid'in U){let Y=this.conn.unmarshalLsession(U.rsid);return Y.unmarshalId(V)}let W=U.lsid;if(W!==this.rsid)throw new q.LookupError('Unknown session: '+W);let X=this.unmarshalId(V);return'bridge'in U?this.unmarshalBridge(X,U.bridge):X}unmarshalBridge(U,V){return new M(U,V)}unmarshalId(U){return new H(this,U)}}class K extends J{constructor(U,V,W=null,X=null,Y=null){super(U,V,W,Y),Promise.resolve(this._open(X)).catch(()=>{}),this._root=this.unmarshalId(null)}root(){return this._root}}class L extends K{constructor(U,V=null,W=null){super(U,U.nextrsid++,V,W)}_open(U){return this.call(null,'open',[this.rsid,U])}close(){return this._root._close()}}class M extends K{constructor(U,V){super(U._rdata.rsession.conn,V.rsid,V.lformat,null,V.dst),this.bridge=U,this._root._closed=!0}_open(){}close(){return this.bridge._close()}}class N extends F{constructor(U,V,W='json',X='json'){super(U),this._rsession=new L(V,null,X),this._lref.bridge={dst:V.id,rsid:this._rsession.rsid,lformat:W}}_close(){this._rsession.close()}}N.help='Bridge between clients.  Allows one client to call methods exposed by another client.';class O{constructor(){this.objects={},this.nextid=0}add(U){let V=this.nextid++;return this.objects[V]=U,V}get(U){return this.objects[U]}remove(U){delete this.objects[U]}}let P=new O;class Q{constructor(U,V={}){if(V.rootFactory)this.rootFactory=V.rootFactory;else{let X=V.root||B;this.rootFactory=Y=>new X(Y)}this.onopen=V.onopen||(()=>{}),this.onclose=V.onclose||(()=>{}),this.log=V.log||((...X)=>{console.log(...X)}),this.lencode=t.registry[V.lformat||'json'].encode,this.rcodec=t.registry[V.rformat||'json'],this.rcodecBin=t.registry[V.rformatBin||'msgpack'],this.lsessions={},this.lcalls={},this.rcalls={},this.bcalls={},this.nextlsid=-2,this.nextrsid=0,this.nextrcid=0,this.header=null,this.headerRcodec=null,new y(this,null,X=>new D(X)),new z(this,-1,X=>new B(X)),this.registry=V.registry?V.registry:P,this.id=this.registry.add(this);let W='string'==typeof U?new e(U):U;3===W.readyState?(this.ws=null,this.registry.remove(this.id),setTimeout(()=>this.onclose(this),0)):(this.ws=W,1===W.readyState?setTimeout(()=>this.onopen(this),0):W.onopen=()=>{this.onopen(this)},W.onclose=()=>{this.ws=null,this.lclose(),this.rclose(),this.onclose(this)},W.onmessage=X=>{if(null===this.header){let Y='string'==typeof X.data?this.rcodec:this.rcodecBin,Z;try{Z=Y.decode(X.data)}catch($){return this.log('Invalid data received on Eider WebSocket connection:',$),void this.close()}'format'in Z&&null!==Z.format?(this.header=Z,this.headerRcodec=Y):this.dispatch(Y,Z)}else this.dispatch(this.headerRcodec,this.header,X.data),this.header=null})}createLocalSession(U=null,V=null,W=null){return null===U&&(U=this.nextlsid--),new y(this,U,V,W)}createSession(U=null,V=null){return new L(this,U,V)}dispatch(U,V,W=null){let X=V.dst;void 0===X&&(X=null);let Y=V.method;if(Y){let Z=V.id;if(void 0===Z&&(Z=null),null===X){let $=V.src;void 0===$&&($=null);try{if(r(Y))throw new q.AttributeError('Cannot call private method \''+Y+'\'');let _;null===W?_=V:(U=t.byname(V.format),_=U.decode(W));let[aa,ba]=this.applyBegin(U,$,Y,_),ca=aa.lcodec;try{let da=this.applyFinish(U,$,Y,aa,ba,_);null!==Z&&da&&'function'==typeof da.then&&'function'==typeof da.cancel&&(this.lcalls[Z]=da),Promise.resolve(da).then(ea=>{null!==Z&&(Z in this.lcalls&&delete this.lcalls[Z],this.respond($,Z,ea,ca))}).catch(ea=>{Z in this.lcalls&&delete this.lcalls[Z],this.onError($,Z,ea,ca)})}catch(da){this.onError($,Z,da,ca)}}catch(_){this.onError($,Z,_)}}else this.bridgeCall(X,Z,V,W)}else{let Z=V.cancel;if(void 0===Z||null===Z){let $=V.id;if(null===X){let _=this.rcalls[$];if(void 0!==_){delete this.rcalls[$];try{let aa;null===W?aa=V:(U=t.byname(V.format),aa=U.decode(W)),_.resolve(this.getresult(U,_.rsession,aa))}catch(aa){_.reject(aa)}}}else this.bridgeResponse(X,$,V,W)}else if(null===X){let $=this.lcalls[Z];void 0!==$&&(delete this.lcalls[Z],$.cancel())}else this.bridgeCall(X,null,V,W)}}bridgeCall(U,V,W,X){let Y=this.registry.get(U);void 0===Y?this.onError(null,V,new q.DisconnectedError('Unknown connection: '+U)):(delete W.dst,W.src=this.id,Y.send(W,X),null!==V&&((Y.bcalls[this.id]||(Y.bcalls[this.id]={}))[V]=1))}bridgeResponse(U,V,W,X){let Y=this.registry.get(U);void 0!==Y&&(this.bcalls[U]&&this.bcalls[U][V]&&delete this.bcalls[U][V],delete W.dst,Y.send(W,X))}unmarshalLsession(U){if(!this.lsessions.hasOwnProperty(U))throw new q.LookupError('Unknown session: '+U);return this.lsessions[U]}applyBegin(U,V,W,X){let Y=X.this,Z,$;if(void 0===Y||null===Y)Z=null,$=null;else if(Array.isArray(Y))throw new TypeError('Malformed this object');else Y instanceof v&&(Y=Y.ref),Z=Y[p],void 0===Z&&(Z=null),$=Y.rsid,void 0===$&&($=null);return[this.unmarshalLsession($),Z]}applyFinish(U,V,W,X,Y,Z){let $=X.unmarshalId(Y),_=s($,W),aa='params'in Z?X.unmarshalAll(U,Z.params,V):[];return _(...aa)}getresult(U,V,W){if('result'in W)return V.unmarshalAll(U,W.result);let X=W.error;if(!X)throw new Error('Unspecified error');let Y=X.message;Y=void 0===Y||''===Y?'Unspecified error':''+Y;let Z=''+X.name,$=q[Z]||c[Z];'function'==typeof $&&($===Error||$.prototype instanceof Error)||($=Error,Z&&(Y=Z+': '+Y));let _=X.stack,aa=new $(Y);throw'string'==typeof _&&('string'==typeof aa.stack?aa.stack=_.trim()+'\n\nThe above exception was the direct cause of the following exception:\n\n'+aa.stack:aa.stack=_),aa}onError(U,V,W,X=null){null===V?this.log(W):((void 0===W.name||void 0===W.message)&&(W=new Error(W)),this.error(U,V,W,X))}close(){null!==this.ws&&(this.ws.close(),this.ws=null,this.registry.remove(this.id))}lclose(){for(let U in this.lsessions)this.lsessions[U].objects[null]._release()}rclose(){for(let U in this.registry.remove(this.id),this.lcalls)this.lcalls[U].cancel();for(let U in this.rcalls)this.rcalls[U].reject(new q.DisconnectedError('Connection lost'));for(let U in this.bcalls){let V=this.registry.get(U);if(void 0!==V)for(let W in this.bcalls[U])V.error(null,W,new q.DisconnectedError('Bridged connection lost'))}for(let U in this.registry.objects){let V=this.registry.objects[U],W=V.bcalls[this.id];if(void 0!==W&&(delete V.bcalls[this.id],null!==V.ws))for(let X in W)V.send({cancel:X})}}sendcall(U,V,W,X,Y,Z=[]){if(null===this.ws)throw new q.DisconnectedError('Connection closed');let $={dst:V,id:W,method:Y},_;null===U?(_=null,$.this=X,$.params=Z):(_=U.encode(this,{this:X,params:Z}),$.format=U.name),this.send($,_)}respond(U,V,W,X){void 0===W&&(W=null);let Y={dst:U,id:V},Z;if(null===X)Z=null,Y.result=W;else{try{Z=X.encode(this,{result:W})}catch($){return void this.error(U,V,$,X)}Y.format=X.name}this.send(Y,Z)}error(U,V,W,X=null){let Y={dst:U,id:V},Z={name:W.name,message:W.message};'string'==typeof W.stack&&(Z.stack=W.stack);let $;if(null===X)$=null,Y.error=Z;else try{$=X.encode(this,{error:Z}),Y.format=X.name}catch(_){$=null,Y.error=Z}this.send(Y,$)}send(U,V=null){null!==this.ws&&(this.ws.send(this.lencode(this,U)),null!==V&&this.ws.send(V))}_enter(){return this}_exit(){this.close()}}let R=function(U,V={}){return new Promise((W,X)=>{let Y=new Q(U,V),Z=V.onclose||(()=>{});Y.onopen=$=>{$.onclose=Z,W($)},Y.onclose=$=>{X(new Error('Could not connect')),Z($)}})},T={asyncIterator:l,Bridge:N,Codec:t,connect:R,Connection:Q,Errors:q,forEachAsync:(U,V)=>j(U[l](),W=>{let X=()=>W.next().then(Y=>{if(!Y.done)return Promise.resolve(V(Y.value)).then(X)});return X()}),LocalObject:F,LocalRoot:B,Reference:v,Registry:O,serve:function(U,V={}){let W=new g({port:U});return W.on('connection',X=>R(X,V)),W},using:j,VERSION:'0.10.0'};'undefined'!=typeof module&&!module.nodeType&&module.exports?module.exports=T:c.Eider=T})();
